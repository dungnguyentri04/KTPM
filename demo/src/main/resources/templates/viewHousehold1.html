<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
	  th:replace="~{base::layout(~{::content})}">

<div class="container" th:fragment="content">
	<div class="page-inner">

		<div class="row">
			<div class="col-md-12">
				<div class="card">
					<div class="card-header">
						<div class="card-title">View Household</div>
					</div>
					<div class="card-body">
						<div class="row">
							<div class="col-md-6 col-lg-6">
								<div class="row">
									<div class="col-sm-4">
										<p class="mb-0">Owner Name</p>
									</div>
									<div class="col-sm-8">
										<p class="text-muted mb-0" id="ownerName"></p>
									</div>
								</div>
								<hr />
								<div class="row">
									<div class="col-sm-4">
										<p class="mb-0">CitizenId</p>
									</div>
									<div class="col-sm-8">
										<p class="text-muted mb-0" id="citizenIdOwner"></p>
									</div>
								</div>
								<hr />
								<div class="row">
									<div class="col-sm-4">
										<p class="mb-0">Phone</p>
									</div>
									<div class="col-sm-8">
										<p class="text-muted mb-0">(097) 234-5678</p>
									</div>
								</div>
								<hr />
								<div class="row">
									<div class="col-sm-4">
										<p class="mb-0">Household number</p>
									</div>
									<div class="col-sm-8">
										<p class="text-muted mb-0" id="numberOfHousehold"></p>
									</div>
								</div>
							</div>

							<div class="col-md-6 col-lg-6">
								<div class="row">
									<div class="col-sm-4">
										<p class="mb-0">Location</p>
									</div>
									<div class="col-sm-8">
										<p class="text-muted mb-0" id="location"></p>
									</div>
								</div>
								<hr />
								<div class="row">
									<div class="col-sm-4">
										<p class="mb-0">Area</p>
									</div>
									<div class="col-sm-8">
										<p class="text-muted mb-0" id="areaCode"></p>
									</div>
								</div>
								<hr />
								<div class="row">
									<div class="col-sm-4">
										<p class="mb-0">Number Of people</p>
									</div>
									<div class="col-sm-8">
										<p class="text-muted mb-0" id="numberOfPeople"></p>
									</div>
								</div>
								<hr />
							</div>
						</div>
					</div>

					<div class="card-action">
						<button class="btn btn-success">Update</button>
						<button class="btn btn-danger" >Back</button>
					</div>
				</div>
			</div>
		</div>

		<div class="row">
			<div class="col-md-12">
				<div class="card">
					<div class="card-header">
						<div class="d-flex align-items-center">
							<h4 class="card-title">Residents</h4>
							<button class="btn btn-primary btn-round ms-auto" data-bs-toggle="modal"
									data-bs-target="#addRowModal">
								<i class="fa fa-plus"></i>
								Add Row
							</button>
						</div>
					</div>
					<div class="card-body">
						<!-- Modal -->

						<div class="table-responsive">
							<table id="add-row" class="display table table-striped table-hover">
								<thead>
								<tr>
									<th>Name</th>
									<th>Age</th>
									<th>Gender</th>
									<th>Relationship</th>
									<th style="width: 10%">Action</th>
								</tr>
								</thead>
								<tbody id="demographicList">
								</tbody>
							</table>
						</div>
					</div>
				</div>
			</div>
		</div>

<!--contributions-->
		<div class="row">
			<div class="col-md-6">
				<div class="card">
					<div class="card-header">
						<div class="d-flex align-items-center">
							<h4 class="card-title">Contributions</h4>
							<button class="btn btn-primary btn-round ms-auto" onclick="addContribution()">
								<i class="fa fa-plus"></i>
								Add Contribution
							</button>
						</div>
					</div>
					<div class="card-body">
						<!-- Modal -->

						<div class="table-responsive table-container" style="min-height: 400px">
							<table class="display table table-striped table-hover">
								<thead>
								<tr>
									<th>Name</th>
									<th>Created At</th>
									<th>Deadline</th>
									<th>Cost</th>
									<th style="width: 5%">Action</th>
								</tr>
								</thead>

								<tbody id="listFeesNotDone">
								</tbody>
							</table>
						</div>
					</div>
				</div>
			</div>
			<div class="col-md-6">
				<div class="card">
					<div class="card-header">
						<div class="d-flex align-items-center">
							<h4 class="card-title">History Contributions</h4>
						</div>
					</div>
					<div class="card-body">
						<!-- Modal -->

						<div class="table-responsive table-container" style="min-height: 400px">
							<table class="display table table-striped table-hover">
								<thead>
								<tr>
									<th>Name</th>
									<th>Done</th>
									<th>Cost</th>
								</tr>
								</thead>

								<tbody id="listFeesDone">
								</tbody>
							</table>
						</div>
					</div>
				</div>
			</div>
		</div>

		<div class="modal fade" id="addRowModal" tabindex="-1" aria-labelledby="addRowModalLabel" aria-hidden="true">
			<div class="modal-dialog modal-dialog-centered">
				<div class="modal-content">
					<div class="modal-header border-0 pb-0">
						<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
					</div>
					<div class="card-header" style="padding: 20px">
						<div class="card-title">Add Member</div>
					</div>
					<div class="modal-body text-center pt-0">
						<form>
							<div class="row">
								<div class="col-md-6">
									<div class="form-group">
										<label for="idMember">Id </label>
										<input id="idMember" type="text"
											   class="form-control" placeholder="Id Member" />
									</div>
								</div>
								<div class="col-md-6">
									<div class="form-group">
										<label for="relationship">Relationship</label>
										<select class="form-select form-control" id="relationship">
											<option>SPOUSE</option>
											<option>CHILD</option>
											<option>PARENT</option>
											<option>GRANDPARENT</option>
											<option>OTHER</option>
										</select>
									</div>
								</div>
							</div>
						</form>
					</div>
					<div class="modal-footer border-0 justify-content-center">
						<button type="button" class="btn btn-secondary px-4" data-bs-dismiss="modal">Cancel</button>
						<button type="button" class="btn btn-danger px-4" id="addMemberBtn">Add</button>
					</div>
				</div>
			</div>
		</div>

		<div class="modal fade" id="deleteContributeModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
			<div class="modal-dialog modal-dialog-centered">
				<div class="modal-content">
					<div class="modal-header border-0 pb-0">
						<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
					</div>
					<div class="modal-body text-center pt-0">
						<div class="mb-3">
							<i class="fas fa-exclamation-triangle text-warning" style="font-size: 3rem;"></i>
						</div>
						<h5 class="modal-title mb-3" id="deleteModalLabel">Xác nhận xóa</h5>
						<p class="mb-0">Bạn có chắc chắn muốn xóa khoản đóng góp cho phí <strong id="contributionNameToDelete">testUser1</strong> không?</p>
						<p class="text-muted small">Hành động này không thể hoàn tác.</p>
					</div>
					<div class="modal-footer border-0 justify-content-center">
						<button type="button" class="btn btn-secondary px-4" data-bs-dismiss="modal">Hủy</button>
						<button type="button" class="btn btn-danger px-4" id="confirmDeleteBtn">Xóa</button>
					</div>
				</div>
			</div>
		</div>
	</div>

	<script>
		const params = new URLSearchParams(window.location.search);
		const householdId = params.get("id");

		// Gọi API để lấy thông tin user
		fetch('/api/households/' + householdId)
			.then(res => {
				if (!res.ok) {
					throw new Error('Không tìm thấy household');
				}
				return res.json();
			})
			.then(response => {

				//View household
				const data = response.data;
				const householdData = data.householdData;
				// Gán dữ liệu vào HTML
				document.getElementById("ownerName").textContent = householdData.ownerName;
				// document.getElementById("alias").textContent = userData.alias;
				document.getElementById("numberOfHousehold").textContent = householdData.numberOfHousehold;
				document.getElementById("location").textContent = householdData.location;
				document.getElementById("numberOfPeople").textContent = householdData.numberOfPeople;
				document.getElementById("citizenIdOwner").textContent = householdData.citizenIdOwner;
				document.getElementById("areaCode").textContent = householdData.areaCode;

				console.log(response)
				console.log(householdData)
				//View List Demographics
				const listDemographics = data.listDemographics;
				console.log(listDemographics)
				const tbody = document.getElementById('demographicList');


				listDemographics.forEach(demographic => {
					const tr = document.createElement('tr');

					tr.innerHTML = `
						<td>${demographic.name}</td>
						<td>${demographic.age}</td>
						<td>${demographic.sex}</td>
						<td>${demographic.relationship}</td>
						<td>
						  <div class="form-button-action">
							<button type="button" class="btn btn-link btn-primary btn-lg"
							  onclick="window.location.href='/viewDemographic?id=${demographic.id}'"
							  data-bs-toggle="tooltip" data-original-title="Edit Task">
							  <i class="fa fa-edit"></i>
							</button>

							<button type="button" class="btn btn-link btn-primary btn-lg"
							  onclick="window.location.href='/addTemporary?type=TEMPORARY_ABSENCE&demographicId=${demographic.id}'"
							  data-bs-toggle="tooltip" data-original-title="add temporary">
							  <i class="fa-solid fa-house" style="color: #4984b2;"></i>
							</button>

							<button type="button" class="btn btn-link btn-danger"
							  onclick=""
							  data-bs-toggle="tooltip"
							  data-original-title="Remove">
							  <i class="fa fa-times"></i>
							</button>
						  </div>
						</td>
      					`;

					tbody.appendChild(tr);
				});
				// document.getElementById("citizenId").textContent = userData.citizenId;
			})
			.catch(err => {
				alert("Lỗi: " + err.message);
			});
	</script>

	<script>
		window.onload = function () {
			const params = new URLSearchParams(window.location.search);
			const idHousehold = params.get("id")
			console.log("fefewifuh")
			const addMemberBtn = document.getElementById('addMemberBtn');
			console.log(idHousehold)
			addMemberBtn.addEventListener('click', () => {
				console.log("fewfewfe")
				const idMember = document.getElementById('idMember').value;
				const relationship = document.getElementById('relationship').value;
				fetch('/api/households/' + idHousehold + '/addDemographics', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json'
					},
					body: JSON.stringify({
						id: idMember,
						relationship: relationship
					})
				})
					.then(async res => {
						const data = await res.json();
						if (!res.ok) {
							throw new Error('error' + data.message);
						}
						return data;
					})
					.then(response => {
						alert('add member success');
						window.location.reload()
					})
					.catch(err => {
						console.log("fheiuhfe" + err.message);
						alert('Lỗi: ' + err.message);
					});
			});
		}
	</script>

	<script>
		function addContribution() {
			console.log("fewfewf")
			const params = new URLSearchParams(window.location.search);
			const idHousehold = params.get("id")
			window.location.href = '/addContribution?householdId=' + idHousehold;
		}

		document.addEventListener("DOMContentLoaded", function () {
			const params = new URLSearchParams(window.location.search);
			const householdId = params.get("id"); //
			fetch("/api/households/" + householdId + "/contributes?status=IN_COMPLETE")
				.then(res => {
					const data = res.json();
					if (!res.ok) {
						throw new Error('error' + data.message);
					}
					return data;
				})
				.then(response => {
					const data = response.data;
					const tbody = document.getElementById("listFeesNotDone");

					data.forEach(contribution => {
						const tr = document.createElement("tr");

						tr.innerHTML = `
						<td>${contribution.feeName}</td>
						<td>${contribution.createdAt}</td>
						<td>${contribution.deadline}</td>
						<td>${contribution.money}</td>
						<td>
						<div class="dropdown">
						<button class="action-button dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
							<i class="fas fa-ellipsis-v"></i>
						</button>
						<ul class="dropdown-menu dropdown-menu-end">
							<li>
								<button class="dropdown-item" href="#" data-contribute-id="${contribution.id}" onclick="doneContribution(${contribution.id})">
									<i class="fas fa-edit me-2"></i>Done
								</button>
							</li>
							<li><hr class="dropdown-divider"></li>
							<li>
								<button class="dropdown-item text-danger" href="#"
								data-bs-toggle="modal" title="Xóa" data-original-title="Remove"
								data-contribute-id="${contribution.id}"
								data-bs-target="#deleteContributeModal" data-contribute-name="${contribution.feeName}"
								>
									<i class="fas fa-trash me-2"></i>Xóa
								</button>
							</li>
						</ul>
						</div>
						</td>
						`
						tbody.appendChild(tr);
					})
				})
				.catch(err => {
					alert('Lỗi: ' + err.message);
				});
		});

		function doneContribution(contributeId) {
			fetch("/api/contributes/" + contributeId,{
				method: 'PATCH',
				headers: {
					'Content-Type': 'application/json'
				},
				body: JSON.stringify({
					status: "COMPLETE"
				})
			})
			.then(async res => {
				const data = await res.json();
				if (!res.ok) {
					throw new Error('error' + data.message);
				}
				return data;
			})
			.then(response => {
				window.location.reload()
			})
			.catch(err => {
				console.log("fheiuhfe" + err.message);
				alert('Lỗi: ' + err.message);
			})
		}
	</script>

	<script>
		document.addEventListener("DOMContentLoaded", function () {
			const params = new URLSearchParams(window.location.search);
			const householdId = params.get("id"); //
			fetch("/api/households/" + householdId + "/contributes?status=COMPLETE")
				.then(res => {
					const data = res.json();
					if (!res.ok) {
						throw new Error('error' + data.message);
					}
					return data;
				})
				.then(response => {
					const data = response.data;
					const tbody = document.getElementById("listFeesDone");

					data.forEach(contribution => {
						const tr = document.createElement("tr");

						tr.innerHTML = `
							<td>${contribution.feeName}</td>
							<td>${contribution.paymentDate}</td>
							<td>${contribution.money}</td>

							`
						tbody.appendChild(tr);
					})
				})
				.catch(err => {
					alert('Lỗi: ' + err.message);
				});
		});
	</script>

	<script>
		document.addEventListener('DOMContentLoaded', function() {
			const deleteModal = document.getElementById('deleteContributeModal');
			const contributeNameElement = document.getElementById('contributionNameToDelete');
			const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
			let currentContributeId = null;

			// Khi modal được mở
			deleteModal.addEventListener('show.bs.modal', function(event) {
				const button = event.relatedTarget; // Nút đã kích hoạt modal
				const contributeName = button.getAttribute('data-contribute-name');
				const contributeId = button.getAttribute('data-contribute-id');

				// Cập nhật tên người dùng trong modal
				contributeNameElement.textContent = contributeName;
				currentContributeId = contributeId;
			});

			// Xử lý khi nhấn nút "Xóa"
			confirmDeleteBtn.addEventListener('click', function() {
				if (currentContributeId) {
					// Thực hiện xóa - có thể gọi API hoặc xử lý logic xóa ở đây
					console.log('Đang xóa người dùng có ID:', currentContributeId);

					fetch("/api/contributes/" + currentContributeId, {
						method: 'DELETE'
					})
						.then(async (response) => {
							const data = await response.json();
							if (response.ok) {
								return data;
							} else {
								throw new Error('Error: ' + data.message);
							}
						})
						.then(data => {
							// Xử lý phản hồi
							alert("delete success");
							location.reload(); // Tải lại trang hoặc cập nhật bảng
						})
						.catch(error => {
							alert("delete fail " + error.message);
							console.error('Error:', error);
							// Xử lý lỗi (ví dụ: hiển thị thông báo lỗi)
						});
				}
			});


		});
	</script>


</div>